<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for Loan - MicroLending Platform</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="container">
        <div class="page-header">
            <h1>Apply for a Loan</h1>
            <p>Complete the form below to submit your loan application</p>
        </div>

        <div class="loan-application-container">
            <form id="loan-application-form" onsubmit="handleLoanApplication(event)">
                <!-- Loan Details -->
                <div class="card">
                    <div class="card-header">
                        <h2>Loan Details</h2>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="loan-amount">Loan Amount *</label>
                            <input type="number" id="loan-amount" step="0.01" min="100" max="100000" required>
                            <small>Minimum: $100, Maximum: $100,000</small>
                        </div>
                        <div class="form-group">
                            <label for="loan-purpose">Loan Purpose *</label>
                            <select id="loan-purpose" required>
                                <option value="">Select purpose...</option>
                                <option value="business">Business Expansion</option>
                                <option value="education">Education</option>
                                <option value="medical">Medical Expenses</option>
                                <option value="agriculture">Agriculture</option>
                                <option value="personal">Personal Use</option>
                                <option value="home">Home Improvement</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loan-term">Loan Term (months) *</label>
                            <input type="number" id="loan-term" min="3" max="60" required>
                            <small>3 to 60 months</small>
                        </div>
                        <div class="form-group">
                            <label for="interest-rate">Requested Interest Rate (%)</label>
                            <input type="number" id="interest-rate" step="0.01" min="5" max="25" value="12">
                            <small>Market range: 5% - 25%</small>
                        </div>
                    </div>
                </div>

                <!-- Loan Description -->
                <div class="card">
                    <div class="card-header">
                        <h2>Application Details</h2>
                    </div>
                    <div class="form-group">
                        <label for="loan-description">Describe your loan purpose *</label>
                        <textarea id="loan-description" rows="5" required
                            placeholder="Provide detailed information about how you plan to use the loan and how you will repay it..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="income-source">Primary Income Source *</label>
                        <input type="text" id="income-source" required placeholder="e.g., Salary, Business, Freelance">
                    </div>
                    <div class="form-group">
                        <label for="monthly-income">Monthly Income ($) *</label>
                        <input type="number" id="monthly-income" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="monthly-expenses">Monthly Expenses ($) *</label>
                        <input type="number" id="monthly-expenses" step="0.01" min="0" required>
                    </div>
                </div>

                <!-- Collateral (Optional) -->
                <div class="card">
                    <div class="card-header">
                        <h2>Collateral (Optional)</h2>
                    </div>
                    <div class="form-group">
                        <label for="collateral-type">Collateral Type</label>
                        <select id="collateral-type">
                            <option value="">No collateral</option>
                            <option value="property">Property</option>
                            <option value="vehicle">Vehicle</option>
                            <option value="equipment">Equipment</option>
                            <option value="inventory">Inventory</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="collateral-value">Estimated Value ($)</label>
                        <input type="number" id="collateral-value" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="collateral-description">Collateral Description</label>
                        <textarea id="collateral-description" rows="3" 
                            placeholder="Describe the collateral you're offering..."></textarea>
                    </div>
                </div>

                <!-- Loan Calculation Preview -->
                <div class="card loan-calculator">
                    <div class="card-header">
                        <h2>Loan Calculation Preview</h2>
                    </div>
                    <div class="calculation-grid">
                        <div class="calc-item">
                            <label>Loan Amount:</label>
                            <span id="calc-amount">$0.00</span>
                        </div>
                        <div class="calc-item">
                            <label>Interest Rate:</label>
                            <span id="calc-rate">0%</span>
                        </div>
                        <div class="calc-item">
                            <label>Term:</label>
                            <span id="calc-term">0 months</span>
                        </div>
                        <div class="calc-item">
                            <label>Monthly Payment:</label>
                            <span id="calc-monthly" class="highlight">$0.00</span>
                        </div>
                        <div class="calc-item">
                            <label>Total Interest:</label>
                            <span id="calc-interest">$0.00</span>
                        </div>
                        <div class="calc-item">
                            <label>Total Repayment:</label>
                            <span id="calc-total" class="highlight">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/nav.js"></script>
    <script>
        async function initApplyLoan() {
            await Navigation.init('apply-loan');
            setupCalculator();
        }

        function setupCalculator() {
            // Update calculator when values change
            ['loan-amount', 'interest-rate', 'loan-term'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculator);
            });
            updateCalculator();
        }

        function updateCalculator() {
            const amount = parseFloat(document.getElementById('loan-amount').value) || 0;
            const rate = parseFloat(document.getElementById('interest-rate').value) || 0;
            const term = parseInt(document.getElementById('loan-term').value) || 0;

            document.getElementById('calc-amount').textContent = formatCurrency(amount);
            document.getElementById('calc-rate').textContent = rate.toFixed(2) + '%';
            document.getElementById('calc-term').textContent = term + ' months';

            if (amount > 0 && rate > 0 && term > 0) {
                const monthlyPayment = calculateMonthlyPayment(amount, rate, term);
                const totalPayment = monthlyPayment * term;
                const totalInterest = totalPayment - amount;

                document.getElementById('calc-monthly').textContent = formatCurrency(monthlyPayment);
                document.getElementById('calc-interest').textContent = formatCurrency(totalInterest);
                document.getElementById('calc-total').textContent = formatCurrency(totalPayment);
            } else {
                document.getElementById('calc-monthly').textContent = '$0.00';
                document.getElementById('calc-interest').textContent = '$0.00';
                document.getElementById('calc-total').textContent = '$0.00';
            }
        }

        async function handleLoanApplication(event) {
            event.preventDefault();

            const applicationData = {
                requested_amount: parseFloat(document.getElementById('loan-amount').value),
                loan_purpose: document.getElementById('loan-purpose').value,
                requested_term_months: parseInt(document.getElementById('loan-term').value),
                requested_interest_rate: parseFloat(document.getElementById('interest-rate').value),
                description: document.getElementById('loan-description').value,
                income_source: document.getElementById('income-source').value,
                monthly_income: parseFloat(document.getElementById('monthly-income').value),
                monthly_expenses: parseFloat(document.getElementById('monthly-expenses').value),
                collateral_type: document.getElementById('collateral-type').value || null,
                collateral_value: parseFloat(document.getElementById('collateral-value').value) || null,
                collateral_description: document.getElementById('collateral-description').value || null
            };

            try {
                const result = await LoanAPI.applyForLoan(applicationData);
                showToast('Loan application submitted successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'my-loans.html';
                }, 2000);
            } catch (error) {
                showToast('Failed to submit application: ' + error.message, 'error');
            }
        }

        window.addEventListener('DOMContentLoaded', initApplyLoan);
    </script>
</body>
</html>
